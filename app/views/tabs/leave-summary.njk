{% from "summary-list/macro.njk" import govukSummaryList %}
{% from "inset-text/macro.njk" import govukInsetText %}
{% from "warning-text/macro.njk" import govukWarningText %}
{% from "../components/leave-block-summary.njk" import leaveBlockSummary %}
{% from "../components/primary-notice.njk" import primaryNotice %}

{% set primaryLeaveType = (data | primaryLeaveType) %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds-from-desktop">
    <h1 class="govuk-heading-l print-show">
    Leave summary
    </h1>
    <p>This summary shows your leave weeks, when you need to notify your employer and how you can apply.</p>
    <p>All start dates are on a Monday. You can choose to start on a different day when you notify your employers.</p>

    {{ govukSummaryList({
      rows: [
        {
          key: {
            text: "Placement date" if data | isAdoption else "Baby is due"
          },
          value: {
            text: data | startDay | formatForDisplay
          }
        }
      ]
    }) }}

    <h2 class="govuk-heading-l">
      {{ data | primaryName | capitalize }}’s leave dates
    </h2>
    <h3 class="govuk-heading-m">
      {{ primaryLeaveType | capitalize }} Leave
    </h3>

    {{ leaveBlockSummary({
      name: (primaryLeaveType | capitalize) + " Leave",
      block: leaveBlocks.primary.initial,
      data: data,
      notify: {
        date: data | startDay | startOfWeek | offsetWeeks(-15),
        explanation: "15 weeks before " + data | startDateName
      }
    }) }}

    {% if leaveBlocks.primary.spl | length === 0 and leaveBlocks.secondary.spl | length > 0 %}
      <h4 class="govuk-heading-s">
        Ending your {{ primaryLeaveType | capitalize }} Leave or Pay
      </h4>
      <p>
        You must end your {{ primaryLeaveType | capitalize }} Leave or pay to create Shared Parental Leave or Pay.
        You can do this by returning to work or curtailing it (committing to end it before you return to work).
      </p>
      <p>
        You must also confirm that you’re not taking shared parental leave and pay and consent to your partner taking it.
      </p>
      <p>
        You can do all of this by submitting the {{ primaryLeaveType | capitalize }} Leave curtailment and Shared Parental Leave consent form
        to your employer at least 8 weeks before your partner wants to start Shared Parental Leave.
      </p>
      {{ primaryNotice ({
        data: data
      }) }}
    {% endif %}

    {% if leaveBlocks.primary.spl.length > 0 %}
      <h3 class="govuk-heading-m">
        Shared Parental Leave ({{ data | primaryName }})
      </h3>
      {% for block in leaveBlocks.primary.spl %}
        {{ leaveBlockSummary({
          name: "Block " + loop.index,
          block: block,
          data: data,
          notify: {
            date: data | startDay | startOfWeek | offsetWeeks(block.start) | offsetWeeks(-8),
            explanation: "8 weeks before block starts",
            asterisk: false
          }
        }) }}
      {% endfor %}
    {% endif %}

    {% if leaveBlocks.secondary.initial or leaveBlocks.secondary.spl.length %}
      <h2 class="govuk-heading-l">
        {{ data | secondaryName | capitalize }}’s leave dates
      </h2>
      {% if leaveBlocks.secondary.initial %}
        <h3 class="govuk-heading-m">
          Paternity Leave
        </h3>

        {% if data | isAdoption %}
          <p>Paternity Leave can start the day your child is placed with you, or within 8 weeks after.</p>
        {% else %}
          <p>Paternity Leave can start once the child is born, or within 8 weeks of the child’s birth.</p>
        {% endif %}

        {{ leaveBlockSummary({
          name: "Paternity Leave",
          block: leaveBlocks.secondary.initial,
          data: data,
          notify: {
            date: data | startDay | startOfWeek | offsetWeeks(-15),
            explanation: "15 weeks before due date"
          }
        }) }}
      {% endif %}

      {% if leaveBlocks.secondary.spl.length %}
        <h3 class="govuk-heading-m">
          Shared Parental Leave ({{ data | secondaryName }})
        </h3>
        {% for block in leaveBlocks.secondary.spl %}
          {{ leaveBlockSummary({
            name: "Block " + loop.index,
            block: block,
            data: data,
            notify: {
              date: data | startDay | startOfWeek | offsetWeeks(block.start) | offsetWeeks(-8),
              explanation: "8 weeks before block starts",
              asterisk: false
            }
          }) }}
        {% endfor %}

        {% if leaveBlocks.primary.spl | length === 0 and leaveBlocks.secondary.spl | length > 0 %}
          {% set formUrl %}
            {% if data | isBirth -%}
              Maternity_Entitlement_Curtailment.docx
              {% set formName %}
                Curtailment of Maternity Entitlement Form
              {% endset %}
            {%- elif data | isAdoption -%}
              Adoption_Entitlement_Curtailment.docx
              {% set formName %}
                Curtailment of Adoption Entitlement Form
              {% endset %}
            {%- else -%}
              Parental_Order_Parent_Entitlement_Curtailment.docx
              {% set formName %}
                Curtailment of Adoption Entitlement Form (for parents getting a parent order for a child through surrogacy)
              {% endset %}
            {%- endif %}
          {% endset %}
          {% set curtailmentWarningHtml %}
            The {{ data | primaryName }} must end their {{ primaryLeaveType | capitalize }} Leave and Pay by returning to work or submitting a curtailment notice to allow their partner to take Shared Parental Leave or Pay.
            {% set href = "/forms/" + formUrl %}
            They can do so by submitting the <a href="{{ href }}">{{ formName }}</a>.
          {% endset %}
          {{ govukWarningText({
            html: curtailmentWarningHtml,
            iconFallBackText: "Warning"
          }) }}
        {% endif %}
      {% endif %}
    {% endif %}

    {{ pushToGoogleAnalyticsDataLayer("primaryBlockleaves_count", 1, "primaryBlockleaves") }}

    {% set partnerInitialLeaveCount = 1 if leaveBlocks.secondary.initial else 0 %}
    {{ pushToGoogleAnalyticsDataLayer("partnerBlockleaves_count", partnerInitialLeaveCount, "partnersBlockleaves") }}

    {% set splLeaveCount = leaveBlocks.primary.spl.length + leaveBlocks.secondary.spl.length %}
    {{ pushToGoogleAnalyticsDataLayer("splBlockleaves_count", splLeaveCount, "splBlockleaves") }}

    {% set totalBlockCount = 1 + partnerInitialLeaveCount + splLeaveCount %}
    {{ pushToGoogleAnalyticsDataLayer("totalBlockleaves_count", totalBlockCount, "totalBlockleaves") }}
  </div>
</div>
