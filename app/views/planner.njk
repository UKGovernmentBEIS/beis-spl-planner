{% from "back-link/macro.njk" import govukBackLink %}
{% from "button/macro.njk" import govukButton %}
{% from "details/macro.njk" import govukDetails %}
{% from "error-summary/macro.njk" import govukErrorSummary %}
{% from "input/macro.njk" import govukInput %}
{% from "hidden-fields/macro.njk" import appendHiddenFields %}
{% from "inset-text/macro.njk" import govukInsetText %}
{% from "components/calendar.njk" import calendar %}
{% from "macro.njk" import pushToGoogleAnalyticsDataLayer %}
{% from "fieldset/macro.njk" import govukFieldset %}

{% extends "layout.njk" %}

{% block pageTitle -%}
  {{ "Create your plan" | pageTitle }}
{%- endblock %}

{% block beforeContent %}
  {{ super() }}

  {{ govukBackLink({
    text: "Back",
    href: backPath()
  }) }}
{% endblock %}

{% set isBirth = (data | isBirth) %}
{% set isAdoption = (data | isAdoption) %}
{% set isUkAdoption = (data | isUkAdoption) %}
{% set isOverseasAdoption = (data | isOverseasAdoption) %}
{% set isSurrogacy = (data | isSurrogacy) %}
{% set birthOrPlacement = (data | birthOrPlacement) %}
{% set primaryName = (data | primaryName) %}
{% set primaryLeaveType = (data | primaryLeaveType) %}

{% block content %}
  {% if (errors | hasCalendarError) %}
    {{ govukErrorSummary({
      titleText: "There is a problem",
      errorList: [
        errors["calendar.shared.no-interaction"],
        errors["calendar.secondary.too-many-paternity-leave-weeks"],
        errors["calendar.shared.too-many-leave-weeks"],
        errors["calendar.shared.too-many-pay-weeks"],
        errors["calendar.primary.pay-without-leave"],
        errors["calendar.secondary.pay-without-leave"],
        errors["calendar.primary.leave-break-before-end-of-compulsory-leave"],
        errors["calendar.primary.pay-break-before-end-of-compulsory-leave"],
        errors["calendar.primary.not-taking-compulsory-leave"],
        errors["calendar.primary.not-taking-enough-adoption-leave"],
        errors["calendar.primary.not-taking-first-week-of-adoption-leave"],
        errors["calendar.primary.not-taking-overseas-adoption-leave-in-first-28-days"],
        errors["calendar.primary.too-early"],
        errors["calendar.secondary.too-early"],
        errors["calendar.primary.too-late"],
        errors["calendar.secondary.too-late"]
      ] | removeEmpty
    }) }}

    {% set errorMessages = errors | errorMessages %}
    {% for message in errorMessages %}
      {{ pushToGoogleAnalyticsDataLayer("error_msg", message, "Errorshown") }}
    {% endfor %}
  {% endif %}
  <div class="govuk-grid-row js-show">
    <div class="govuk-grid-column-two-thirds-from-desktop">
      <h1 class="govuk-heading-xl">
        Plan Shared Parental Leave and Pay
      </h1>
      <p class="print-hide">
        Use the calendar below to plan Shared Parental Leave and Pay alongside {{ primaryLeaveType | capitalize }} and Paternity Leave and Pay.
        Alternatively, you can plan your leave by <a href="/planner/maternity-leave/start">answering questions</a>.
      </p>
      <p class="print-hide">
        The dates shown are based on {{ "the week your child starts living with you" if isAdoption else "your childâ€™s birth week" }}. 
        There are separate columns for the mother and the partner. 
        Select the weeks each parent wants to take as leave by clicking in the leave column within the calendar.
      </p>
      <p class="print-hide">
        You can also select which leave weeks are paid and unpaid by clicking on any tick icons within the pay column.
      </p>
      <p class="print-hide">
        The calendar will give an indication of how much statutory pay you can expect to receive, based on the salary you have entered. 
        Your employer can confirm your exact pay amounts. 
        All leave weeks start on a Monday, you can choose a different day to start your leave when you give notice to your employer.
      </p> 
    
      {% set examples %}
        <span class="govuk-hint">
          Examples will open in a new page.
        </span>
        {% set examplePath = "/planner/examples/" + data["nature-of-parenthood"] %}
        <ul class="govuk-list govuk-list--bullet">
          <li>
            <a class="govuk-link" target="_blank" href="{{ examplePath }}/managing-parenting-and-work">
              Managing parenting and work
            </a>
          </li>
          <li>
            <a class="govuk-link" target="_blank" href="{{ examplePath }}/extending-time-as-a-family">
              Extending time as a family after {{ "your child is placed" if isAdoption else "birth" }}
            </a>
          </li>
          <li>
            <a class="govuk-link" target="_blank" href="{{ examplePath }}/sharing-primary-care-responsibility">
              Sharing primary care responsibility
            </a>
          </li>
        </ul>
      {% endset %}

      {{ govukDetails({
        summaryText: "Examples of Shared Parental Leave and Pay plans",
        html: examples,
        classes: "print-hide"
      }) }}
    </div>
  </div>
  <form id="leave-and-pay" method="POST">
    <div class="govuk-grid-row print-hide js-hide">
      <div class="govuk-grid-column-two-thirds-from-desktop">
        <h1 class="govuk-heading-xl">
          Plan Shared Parental Leave and Pay
        </h1>
        <p>
          You must have JavaScript enabled to use the interactive leave and pay calendar, but you can still
          <a href="/planner/maternity-leave/start">
            plan your leave by answering questions
          </a>.
        </p>
      </div>
    </div>
    {% call govukFieldset({
      legend: {
        html: "<h2 class=\"govuk-heading-m govuk-!-margin-0\">Leave and Pay</h2>",
        classes: "govuk-fieldset__legend--m"
      }
    }) %}
      {% call appendHiddenFields(data) %}
        {{ calendar(data) }}
      {% endcall %}
    {% endcall %}
    <div class="govuk-grid-row print-hide js-show">
      <div class="govuk-grid-column-two-thirds-from-desktop">
        <h2 class="govuk-heading-s">
          Full summary
        </h2>
        <p>
          If your plan is complete, continue for a summary of key dates and guidance on
          how to notify your employer.
        </p>
        {{ govukButton({
          text: "Continue"
        }) }}
      </div>
    </div>
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds-from-desktop govuk-grid-column-full">
        <h2 class="govuk-heading-s">
          Help us improve this service
        </h2>
        <p class="govuk-body">
          <a href="/feedback" class="govuk-link">What did you think of this service?</a> (takes 30 seconds)
        </p>
      </div>
    </div>
  </form>
{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  <script>
    window.planner.init({{ data | dump | safe }}, true)
    window.analytics.planner()
  </script>
{% endblock %}
