{% from "back-link/macro.njk" import govukBackLink %}
{% from "button/macro.njk" import govukButton %}
{% from "details/macro.njk" import govukDetails %}
{% from "error-summary/macro.njk" import govukErrorSummary %}
{% from "input/macro.njk" import govukInput %}
{% from "hidden-fields/macro.njk" import appendHiddenFields %}
{% from "inset-text/macro.njk" import govukInsetText %}
{% from "components/calendar.njk" import calendar %}
{% from "macro.njk" import pushToGoogleAnalyticsDataLayer %}

{% extends "layout.njk" %}

{% block pageTitle -%}
  {{ "Create your plan" | pageTitle }}
{%- endblock %}

{% block beforeContent %}
  {{ super() }}

  {{ govukBackLink({
    text: "Back",
    href: backPath()
  }) }}
{% endblock %}

{% set isBirth = (data | isBirth) %}
{% set isAdoption = (data | isAdoption) %}
{% set isUkAdoption = (data | isUkAdoption) %}
{% set isOverseasAdoption = (data | isOverseasAdoption) %}
{% set isSurrogacy = (data | isSurrogacy) %}
{% set birthOrPlacement = (data | birthOrPlacement) %}
{% set primaryName = (data | primaryName) %}
{% set primaryLeaveType = (data | primaryLeaveType) %}

{% block content %}
  {% if (errors | hasCalendarError) %}
    {{ govukErrorSummary({
      titleText: "There is a problem",
      errorList: [
        errors["calendar.shared.no-interaction"],
        errors["calendar.secondary.too-many-paternity-leave-weeks"],
        errors["calendar.shared.too-many-leave-weeks"],
        errors["calendar.shared.too-many-pay-weeks"],
        errors["calendar.primary.pay-without-leave"],
        errors["calendar.secondary.pay-without-leave"],
        errors["calendar.primary.leave-break-before-end-of-compulsory-leave"],
        errors["calendar.primary.pay-break-before-end-of-compulsory-leave"],
        errors["calendar.primary.not-taking-compulsory-leave"],
        errors["calendar.primary.not-taking-enough-adoption-leave"],
        errors["calendar.primary.not-taking-first-week-of-adoption-leave"],
        errors["calendar.primary.not-taking-overseas-adoption-leave-in-first-28-days"],
        errors["calendar.primary.too-early"],
        errors["calendar.secondary.too-early"],
        errors["calendar.primary.too-late"],
        errors["calendar.secondary.too-late"]
      ] | removeEmpty
    }) }}

    {% set errorMessages = errors | errorMessages %}
    {% for message in errorMessages %}
      {{ pushToGoogleAnalyticsDataLayer("error_msg", message, "Errorshown") }}
    {% endfor %}
  {% endif %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">
      <h1 class="govuk-heading-xl">
        Plan Shared Parental Leave and Pay
      </h1>
      <p class="print-hide">
        Use the calendar below to plan Shared Parental Leave and Pay alongside {{ primaryLeaveType | capitalize }} and Paternity Leave and Pay.
        Alternatively, you can plan your leave by answering questions.
      </p>
      <p class="print-hide">
        The dates shown are based on {{ "the week your child starts living with you" if isAdoption else "your child’s birth week" }}.
      </p>

      <h2 class="govuk-heading-s print-hide">
        How much leave you can get
      </h2>
      <p class="print-hide">
        You have 52 weeks of leave to split between you.
      </p>
      <p class="print-hide">
        The {{ primaryName }} must take at least 2 of these weeks of leave
        {% if (isBirth or isSurrogacy) %}
          when the child is born.
        {% elif isUkAdoption %}
          when the child is placed with you.
        {% elif isOverseasAdoption %}
          starting within the first 28 days that the child arrives in the UK.
        {% endif %}
      </p>
      <p class="print-hide">
        The partner can take an additional 2 weeks as Paternity Leave in the first 8 weeks after the child is {{ "placed with you" if isAdoption else "born" }}, if they are eligible.
      </p>

      <h2 class="govuk-heading-s print-hide">
        How much pay you can get
      </h2>
      <p class="print-hide">
        You have 39 weeks of pay to split between you.
      </p>
      <p class="print-hide">
        If the {{ primaryName }} is eligible for Statutory {{ primaryLeaveType | capitalize }} Pay, they get 90% of their average weekly earnings for the first 6 weeks.
      </p>
      <p class="print-hide">
        For the remaining paid weeks, each eligible parent can get the statutory pay rate of £{{ statutory_maximum_pay }} per week,
        or 90% of their average weekly salary, whichever is lower.
      </p>
      <h2 class="govuk-heading-s print-hide">
        When you can start
      </h2>
      {% if (isSurrogacy or isOverseasAdoption) %}
        <p class="print-hide">
          The {{ primaryName }} and the partner can take leave from the {{ birthOrPlacement }} date.
        </p>
        <p class="print-hide">
          Parents can take leave at the same time, or one after the other.
        </p>
      {% else %}
        <p class="print-hide">
          The {{ primaryName }} can start their leave up to {{ data | earliestPrimaryLeaveWeek | abs }} weeks before the {{ birthOrPlacement }}.
          The partner can only take leave after the child is {{ "placed with you" if isAdoption else "born" }}.
        </p>
        <p class="print-hide">
          The {{ primaryName }} and the partner can take leave at the same time, or one after the other.
        </p>
      {% endif %}

      <h2 class="govuk-heading-s print-hide">
        Blocks of leave
      </h2>
      <p class="print-hide">
        {{ primaryLeaveType | capitalize }} Leave and Pay must be taken in one continuous block.
        Shared Parental Leave can be taken in blocks separated by work or other leave.
      </p>

      <p class="print-hide">
        You’re entitled to three blocks of Shared Parental Leave, or more if your employer allows.
      </p>

      {% set examples %}
        <span class="govuk-hint">
          Examples will open in a new page.
        </span>
        {% set examplePath = "/planner/examples/" + data["nature-of-parenthood"] %}
        <ul class="govuk-list govuk-list--bullet">
          <li>
            <a class="govuk-link" target="_blank" href="{{ examplePath }}/managing-parenting-and-work">
              Managing parenting and work
            </a>
          </li>
          <li>
            <a class="govuk-link" target="_blank" href="{{ examplePath }}/extending-time-as-a-family">
              Extending time as a family after {{ "your child is placed" if isAdoption else "birth" }}
            </a>
          </li>
          <li>
            <a class="govuk-link" target="_blank" href="{{ examplePath }}/sharing-primary-care-responsibility">
              Sharing primary care responsibility
            </a>
          </li>
        </ul>
      {% endset %}

      {{ govukDetails({
        summaryText: "Examples of Shared Parental Leave and Pay plans",
        html: examples,
        classes: "print-hide"
      }) }}
    </div>
  </div>
  <form id="leave-and-pay" method="POST">
    <div class="govuk-grid-row print-hide js-hide">
      <div class="govuk-grid-column-two-thirds-from-desktop">
        <h2 class="govuk-heading-l">
          Your plan
        </h2>
        <p>
          You must have JavaScript enabled to use the interactive leave and pay calendar, but you can still
          <a href="/planner/maternity-leave/start">
            plan your leave by answering questions
          </a>.
        </p>
      </div>
    </div>
    <div class="govuk-grid-row print-hide js-show">
      <div class="govuk-grid-column-two-thirds-from-desktop">
        <h2 class="govuk-heading-l">
          Your plan
        </h2>
        {% set accessibleViewInsetHtml %}
          <p class="govuk-body-s">
            Below is an interactive calendar to plan your leave.
          </p>
          <p class="govuk-body-s">
            If you prefer, you can plan your leave by answering questions.
          </p>
          <p class="govuk-body-s">
            This is particularly recommended for users of assistive technology.
          </p>
          <p class="govuk-body-s">
            <a href="/planner/maternity-leave/start" class="govuk-body-s">
              Plan leave by answering questions
            </a>
          </p>
        {% endset %}
        {{ govukInsetText({
          html: accessibleViewInsetHtml
        }) }}
        <p>
          Click in the calendar to select the weeks each parent wants to take as leave.
          There are separate columns for the {{ primaryName }} and the partner, and for leave and pay.
        </p>
        <p>
          You can also select which leave weeks are paid and unpaid.
          The statutory pay amount is {% if data | hasEitherSalary %} based on your salary and is {% endif %} indicative only.
          Your employer can confirm your exact pay amount.
        </p>
        <p>
          All leave weeks in the calendar start on a Monday.
          You can choose a different day to start your leave when you give notice to your employer.
        </p>
        <p>
          After you’ve selected leave and pay for each parent, continue for a summary of key dates and guidance on
          how to notify your employer.
        </p>
      </div>
    </div>
    {% call appendHiddenFields(data) %}
      {{ calendar(data) }}
    {% endcall %}
    <div class="govuk-grid-row print-hide js-show">
      <div class="govuk-grid-column-two-thirds-from-desktop">
        <p>
          If your plan is complete, continue for a summary of key dates and guidance on
          how to notify your employer.
        </p>
        {{ govukButton({
          text: "Continue"
        }) }}
      </div>
    </div>
  </form>
{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  <script>
    window.planner.init({{ data | dump | safe }}, true)
    window.analytics.planner()
  </script>
{% endblock %}
